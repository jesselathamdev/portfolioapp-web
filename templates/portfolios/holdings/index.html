{% extends "base_two_columns.html" %}
{% load humanize %}

{% block browser_title %}Holdings{% endblock browser_title %}

{% block breadcrumbs %}<a href="/">Home</a> &rarr; <a href="{% url 'portfolio_index' %}">Portfolios</a> &rarr; {{ portfolio.name }}{% endblock breadcrumbs %}

{% block page_title %}<i class="icon-book"></i> Holdings <small><a href="#createModal" role="button" data-toggle="modal">add</a></small>{% endblock page_title %}

{% block content %}
{% if holdings %}
<table class="table table-striped table-striped-white table-hover table-bordered table-clickable table-options">
  <thead>
    <tr>
      <th style="width: 22%;">Name</th>
      <th class="align-right" style="width: 17%;">Last Price</th>
      <th class="align-right" style="width: 12%;">Shares</th>
      <th class="align-right" style="width: 12%;">Book Value<br /><span class="small">Avg Cost</span></th>
      <th class="align-right" style="width: 12%;">Market Value</th>
      <th class="align-right" style="width: 10%;">Net Gain</th>
      <th class="align-right" style="width: 10%;">Portfolio<br />Makeup</th>
      <th style="width: 5%">&nbsp;</th>
    </tr>
  </thead>
  <tbody>
  {% for holding in holdings %}
    <tr>
      <td>
        <a class="large" href="{% url 'transaction_index' portfolio.id holding.id %}">{{ holding.stock_symbol }}:{{ holding.market_code }}</a><br />
        {{ holding.stock_name }}
      </td>
      <td class="align-right"><span class="medium">
        ${{ holding.last_price|floatformat:2|intcomma }}</span><br />
        <span class="small">{{ holding.date_last_price_updated }}</span>
      </td>
      <td class="align-right"><span class="medium">{{ holding.total_quantity|default_if_none:"0.00"|floatformat:5|intcomma }}</span></td>
      <td class="align-right"><span class="medium">
        ${{ holding.book_value|floatformat:2|intcomma }}</span><br />
        <span class="small">${{ holding.avg_cost|default_if_none:"0.00"|floatformat:2|intcomma }}</span>
      </td>
      <td class="align-right"><span class="medium">${{ holding.market_value|floatformat:2|intcomma }}</span></td>
      <td {% if holding.market_value > holding.book_value %}class="align-right indicator-gain"{% elif holding.market_value < holding.book_value %}class="align-right indicator-loss"{% else %}class="align-right"{% endif %}>
        <span class="medium">${{ holding.net_gain_dollar|floatformat:2|intcomma }}</span><br />
        <span class="small">{{ holding.net_gain_percent|floatformat:2|intcomma }}%</span>
      </td>
      <td class="align-right"><span class="medium">{{ holding.portfolio_makeup_percent|floatformat:2 }}%</span></td>
      <td class="row-options">
        <a href="#"><i class="icon-cog"></i></a>
        <div class="table-context-menu">
          <ul>
            <li><a href="#" class="modalDelete" data-holding-id="{{ holding.id }}" data-portfolio-id="{{ portfolio.id }}" data-name="{{ holding.stock_name }}">Delete holding</a></li>
          </ul>
        </div>
      </td>
    </tr>
  {% endfor %}
  </tbody>
  <tfoot>
    {% if cash %}
    <tr class="cash">
      <td>Cash</td>
      <td>&nbsp;</td>
      <td>&nbsp;</td>
      <td class="align-right">${{ cash.total_amount|default_if_none:"0.00"|floatformat:2|intcomma }}</td>
      <td class="align-right">${{ cash.total_amount|default_if_none:"0.00"|floatformat:2|intcomma }}</td>
      <td>&nbsp;</td>
      <td class="align-right">&nbsp;</td>
      <td class="align-right">&nbsp;</td>
    </tr>
    {% endif %}
    <tr class="total">
      <th><strong>Total</strong></th>
      <th>&nbsp;</th>
      <th>&nbsp;</th>
      <th class="align-right"><strong>${{ holding_summary.total_book_value|floatformat:2|intcomma }}</strong></th>
      <th class="align-right"><strong>${{ holding_summary.total_market_value|floatformat:2|intcomma }}</strong></th>
      <th {% if holding_summary.total_net_gain_dollar > 0 %}class="align-right indicator-gain"{% elif holding_summary.total_net_gain_dollar < 0 %}class="align-right indicator-loss"{% else %}class="align-right"{% endif %}><strong>${{ holding_summary.total_net_gain_dollar|floatformat:2|intcomma }}</strong></th>
      <th class="align-right">100%</th>
      <th class="align-right">&nbsp;</th>
    </tr>
  </tfoot>
</table>
{% else %}
<p>You currently have no holdings in this portfolio - <a href="{% url 'holding_create' portfolio.id %}">go ahead and add some now!</a></p>
{% endif %}

<div id="createModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="createHoldingModalLabel" aria-hidden="true">
  <form method="post" action="{% url "holding_create" portfolio.id %}">
    {% csrf_token %}
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
      <h3 id="createHoldingModalLabel">Add Holding</h3>
    </div>
    <div class="modal-body">
      <label class="control-label" for="stock_display">Name (or symbol): </label>
      <div class="controls">
        <input id="stock_display" name="stock_name" type="text" class="span6" placeholder="start typing..." />
      </div>
    </div>
    <div class="modal-footer">
      <input type="submit" class="btn btn-success" value="Add holding" />
      <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
    </div>
    <input type="hidden" id="{{ form.stock.auto_id }}" name="{{ form.stock.html_name }}" value="">
  </form>
</div>

<div id="modalDelete" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="deleteModalLabel">Delete Holding</h3>
  </div>
  <div class="modal-body">
    <p>Are you sure you want to delete the selected holding named <b><span id="holding_name"></span></b>?  This action cannot be undone.</p>
    <input type="hidden" id="holding_id" name="holding_id" value="">
  </div>
  <div class="modal-footer">
    <a href="#" class="btn btn-primary" id="modalDeleteButton">Delete holding</a>
    <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
  </div>
</div>

{% endblock content %}

{% block sidebar %}
<div class="widget widget-simple">
  <div class="widget-header">
    <h3>Portfolio Makeup</h3>
  </div>
  <div class="widget-body">
    <div id="holdings-chart" style="height: 260px;"></div>
  </div>
</div>
{% endblock sidebar %}

{% block script %}
<script type="text/javascript" src="{{ STATIC_URL }}js/holdings.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/highcharts/highcharts.js"></script>
<script type="text/javascript">
    $(function () {
        var chart;
        $(document).ready(function() {
            Highcharts.theme = {
                colors: [ "#3A703A", "#4E954E", "#61ba61", "#81C881", "#A0D6A0", "#C0E3C0"],
                chart: {
                    backgroundColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 0,
                    plotBackgroundColor: 'rgba(255, 255, 255, .9)',
                    plotShadow: true,
                    plotBorderWidth: 1
                }
            };

            var highchartsOptions = Highcharts.setOptions(Highcharts.theme);

            Highcharts.getOptions().colors = Highcharts.map(Highcharts.getOptions().colors, function(color) {
                return {
                    radialGradient: { cx: 0.5, cy: 0.3, r: 0.7 },
                    stops: [
                        [0, color],
                        [1, Highcharts.Color(color).brighten(-0.3).get('rgb')] // darken
                    ]
                };
            });

            chart = new Highcharts.Chart({
                chart: {
                    renderTo: 'holdings-chart',
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false,
                    margin: [0, 0, 0, 0],
                    spacingTop: 0,
                    spacingBottom: 0,
                    spacingLeft: 0,
                    spacingRight: 0
                },
                credits: {
                    enabled: false
                },
                title: {
                    text: ''
                },
                tooltip: {
                    formatter: function() {
                      return '<b>'+ this.point.name +':</b> '+ Math.round(this.percentage*10)/10 +'%';
                    }
                },
                plotOptions: {
                    pie: {
                        size:'95%',
                        allowPointSelect: true,
                        cursor: 'pointer',
                        borderWidth: 2,
                        innerSize: '35%',
                        dataLabels: {
                            align: 'right',
                            x: 0,
                            y: 0,
                            enabled: true,
                            distance: -30,
                            color: '#ffffff',
                            backgroundColor: 'rgba(30, 30, 30, .9)',
                            borderRadius: 3,
                            connectorColor: '#000000',
                            formatter: function() {
                                return '<b>'+ this.point.name +':</b> '+ Math.round(this.percentage*10)/10 +'%';
                            }
                        }
                    }
                },
                series: [{
                    type: 'pie',
                    name: 'Holding share',
                    data: {{ holding_chart|safe }},
                    startAngle: 90
                }]
            });
        });

    });
</script>
{% endblock script %}